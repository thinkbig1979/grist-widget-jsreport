<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Generate Quote</title>
    <script src="https://unpkg.com/@jsreport/browser-client/dist/jsreport.umd.js"></script>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  </head>

  <body>
    <div id="app">
      <button id="generate-quote-btn">Generate Quote</button>
    </div>

    <script>
      let baseURL;
      let template;
      let data;
      let authUser;
      let authPassword;
      let fileName;

      grist.ready({
        columns: ["DocumentName", "Template", "QuoteID"],
        requiredAccess: "read table",
      });

      grist.onRecord(function (record, mappings) {
        const mapped = grist.mapColumnNames(record);
        // First check if all columns were mapped.
        if (mapped) {
          console.log(
            `Using ${mappings.DocumentName} and ${mappings.QuoteID} and ${mappings.Template} columns`
          );
          // const recordTemplate = mapped.Template;
          const recordTemplate = JSON.parse(mapped.Template);
          // console.log("mytemplate: ", recordTemplate);

          // Define the variables
          baseURL = recordTemplate.url;
          // console.log("baseURL: ", baseURL);
          template = recordTemplate.body.template;
          // console.log("template: ", template);
          data = recordTemplate.body.data;
          // console.log("data: ", data);
          authUser = recordTemplate.user;
          // console.log("authuser: ", authUser);
          authPassword = recordTemplate.pw;
          // console.log("pw: ", authPassword);
          fileName = mapped.DocumentName;
          // console.log("filename: ", fileName);
          data.quoteID = mapped.QuoteID;
          // console.log("quoteID: ", data.quoteID);

        } else {
          // Helper returned a null value. It means that not all
          // required columns were mapped.
          console.error("Please map all columns");
        }

        jsreport.headers["Authorization"] =
          "Basic " + btoa(`${authUser}:${authPassword}`);
        jsreport.serverUrl = baseURL;

        async function getFile() {
          try {
            const report = await jsreport.render({
              template,
              data,
            });
            // download the output to the file
            report.download(`${fileName}.pdf`);
          } catch (error) {
            console.error("Error generating report:", error);
          }
        }
        // function render() {
          // const app = document.getElementById("app");

          // Create button element
          // const button = document.createElement("button");
          // button.id = "generate-quote-btn";
          // button.textContent = "Generate Quote";

          // Append button to the app div
          // app.appendChild(button);

          // Add event listener to the button
          document
            .getElementById("generate-quote-btn")
            .addEventListener("click", async function () {
              console.log("Click!!");
              await getFile();
            });
          // }
          // Call the render function to initialize the UI
          // render();
      });
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Generate Quote</title>
    <script src="https://unpkg.com/@jsreport/browser-client/dist/jsreport.umd.js"></script>
</head>

<body>
    <button id="generate-quote-btn" style="background-color: orange">
        Generate Quote
    </button>
    <script>


        grist.ready({
            columns: ['Document Name', 'Template', 'Quote ID'],
            requiredAccess: "read table"
        });


        grist.onRecord(function (record, mappings) {
            const mapped = grist.mapColumnNames(record);
            // First check if all columns were mapped.
            if (mapped) {
                console.log(`Using ${mappings.["Document Name"]} and ${mappings.["Quote ID"]} and ${mappings.Template} columns`);
            } else {
                // Helper returned a null value. It means that not all
                // required columns were mapped.
                console.error("Please map all columns");
            }


            // Define the variables
            const baseURL = record.mapped.Template.url;
            let template = record.mapped.Template.body.template;
            let data = record.mapped.Template.body.data;
            const authUser = record.mapped.Template.user;
            const authPassword = record.mapped.Template.pw;
            const fileName = record.mapped.["Document Name"];
            data.quoteID = mapped.["Quote ID"];

            jsreport.headers["Authorization"] =
                "Basic " + btoa(`${authUser}:${authPassword}`);
            jsreport.serverUrl = baseURL;

            async function getFile() {
                try {
                    const report = await jsreport.render({
                        template,
                        data,
                    });
                    // download the output to the file
                    report.download(`${fileName}.pdf`);
                } catch (error) {
                    console.error("Error generating report:", error);
                }
            }
            document
                .getElementById("generate-quote-btn")
                .addEventListener("click", async function () {
                    await getFile();
                });
        });
    </script>
</body>

</html>
